AWSTemplateFormatVersion: '2010-09-09'
Description: 'VPC infrastructure for GovCloud partition with VPN connectivity and VPC endpoints'

Parameters:
  Environment:
    Type: String
    Default: 'prod'
    Description: 'Environment name for resource tagging'
  
  ProjectName:
    Type: String
    Default: 'cross-partition-vpn'
    Description: 'Project name for resource naming'

Resources:
  # VPC with no internet gateway for complete private connectivity
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: '10.0.0.0/16'
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-vpc'
        - Key: Environment
          Value: !Ref Environment
        - Key: Partition
          Value: 'govcloud'

  # Private subnet for Lambda deployment
  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.1.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-private-subnet'
        - Key: Environment
          Value: !Ref Environment
        - Key: Type
          Value: 'private'

  # VPN subnet for VPN Gateway
  VPNSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.2.0/24'
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-vpn-subnet'
        - Key: Environment
          Value: !Ref Environment
        - Key: Type
          Value: 'vpn'

  # VPC Endpoints subnet
  VPCEndpointsSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: '10.0.3.0/24'
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-endpoints-subnet'
        - Key: Environment
          Value: !Ref Environment
        - Key: Type
          Value: 'endpoints'

  # Route table for private subnet - no internet gateway routes
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-private-rt'
        - Key: Environment
          Value: !Ref Environment

  # Associate private subnet with route table
  PrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  # Route table for VPC endpoints subnet
  VPCEndpointsRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-endpoints-rt'
        - Key: Environment
          Value: !Ref Environment

  # Associate VPC endpoints subnet with route table
  VPCEndpointsSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref VPCEndpointsSubnet
      RouteTableId: !Ref VPCEndpointsRouteTable

  # Security group for Lambda functions
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Security group for Lambda functions in private subnet'
      VpcId: !Ref VPC
      SecurityGroupEgress:
        # Allow HTTPS to VPC endpoints
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '10.0.3.0/24'
          Description: 'HTTPS access to VPC endpoints'
        # Allow all traffic to Commercial VPC via VPN
        - IpProtocol: -1
          CidrIp: '172.16.0.0/16'
          Description: 'Cross-partition access via VPN to Commercial'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-lambda-sg'
        - Key: Environment
          Value: !Ref Environment

  # Security group for VPC endpoints
  VPCEndpointsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Security group for VPC endpoints'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Allow HTTPS from Lambda security group
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: 'HTTPS access from Lambda functions'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-endpoints-sg'
        - Key: Environment
          Value: !Ref Environment

  # Network ACL for additional security
  PrivateNetworkAcl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-private-nacl'
        - Key: Environment
          Value: !Ref Environment

  # Allow inbound HTTPS from VPC
  PrivateNetworkAclInboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: '10.0.0.0/16'
      PortRange:
        From: 443
        To: 443

  # Allow inbound from Commercial VPC
  PrivateNetworkAclInboundCommercial:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateNetworkAcl
      RuleNumber: 110
      Protocol: -1
      RuleAction: allow
      CidrBlock: '172.16.0.0/16'

  # Allow outbound HTTPS to VPC endpoints
  PrivateNetworkAclOutboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: '10.0.3.0/24'
      PortRange:
        From: 443
        To: 443

  # Allow outbound to Commercial VPC
  PrivateNetworkAclOutboundCommercial:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateNetworkAcl
      RuleNumber: 110
      Protocol: -1
      RuleAction: allow
      CidrBlock: '172.16.0.0/16'

  # Associate private subnet with Network ACL
  PrivateSubnetNetworkAclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      NetworkAclId: !Ref PrivateNetworkAcl

  # VPC Flow Logs for monitoring
  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchLogPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: '*'

  # CloudWatch Log Group for VPC Flow Logs
  VPCFlowLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/vpc/flowlogs/${ProjectName}-govcloud'
      RetentionInDays: 30

  # VPC Flow Logs
  VPCFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VPCFlowLogsGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-govcloud-flow-logs'
        - Key: Environment
          Value: !Ref Environment

Outputs:
  VPCId:
    Description: 'VPC ID for GovCloud partition'
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VPCId'

  PrivateSubnetId:
    Description: 'Private subnet ID for Lambda deployment'
    Value: !Ref PrivateSubnet
    Export:
      Name: !Sub '${AWS::StackName}-PrivateSubnetId'

  VPNSubnetId:
    Description: 'VPN subnet ID for VPN Gateway'
    Value: !Ref VPNSubnet
    Export:
      Name: !Sub '${AWS::StackName}-VPNSubnetId'

  VPCEndpointsSubnetId:
    Description: 'VPC endpoints subnet ID'
    Value: !Ref VPCEndpointsSubnet
    Export:
      Name: !Sub '${AWS::StackName}-VPCEndpointsSubnetId'

  LambdaSecurityGroupId:
    Description: 'Security group ID for Lambda functions'
    Value: !Ref LambdaSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-LambdaSecurityGroupId'

  VPCEndpointsSecurityGroupId:
    Description: 'Security group ID for VPC endpoints'
    Value: !Ref VPCEndpointsSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-VPCEndpointsSecurityGroupId'

  PrivateRouteTableId:
    Description: 'Route table ID for private subnet'
    Value: !Ref PrivateRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTableId'

  VPCCidr:
    Description: 'CIDR block for GovCloud VPC'
    Value: '10.0.0.0/16'
    Export:
      Name: !Sub '${AWS::StackName}-VPCCidr'